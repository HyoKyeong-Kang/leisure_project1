<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=976e820c4563105a585eb83c8ea88bd6&libraries=services"></script>

<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script th:src="@{/js/kty_review.js}"></script>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<meta charset="UTF-8">
<title>경상도숙박장사</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link rel="stylesheet" href="/css/product_detail.css">
<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
<!-- 다음 주소 검색 api-->
<script th:src="@{/js/product_detail.js}"></script>
<link rel="stylesheet" href="css/kty_review.css">

<!-- 김도겸 css -->
<link rel="stylesheet" href="/css/product_detail_kdg.css">
<!-- 김도겸 css 끝 -->

</head>
<body>
<html layout:decorate="~{jjj/header}">
<div layout:fragment="content" class="container my-3">
   <div class="page_container">
      <div class="page_left">
         <div class="left_main_image">
            <img class="fixed_image" th:src="${acc.acc_img}" alt="숙소">
         </div>
      </div>
      <!--  page container 끝 -->


      <div class="page_right">
         <!--  숙소명 -->
         <p class="hotelname" th:text="${acc.acc_name}"></p>
         <!--  평점 -->
         <span class="score_start"
            th:text="${acc.acc_rating eq 1 ? '★ ✩ ✩ ✩ ✩' : 
                                 acc.acc_rating eq 2 ? '★ ★ ✩ ✩ ✩' :
                                 acc.acc_rating eq 3 ? '★ ★ ★ ✩ ✩' :
                                 acc.acc_rating eq 4 ? '★ ★ ★ ★ ✩ ' :
                                 acc.acc_rating eq 5 ? '★ ★ ★ ★ ★' :
                                 '✩ ✩ ✩ ✩ ✩'}"></span>&nbsp
         <span id="acc_score"
            th:text="${acc.acc_rating eq 0 ? '': acc.acc_rating}"></span> <span
            style="font-size: 13px;" th:if="${#lists.size(acc.reviews) > 0}"
            th:text="'(' + ${#lists.size(acc.reviews)} + ')'"></span>

         <p class="hoteladdress" th:text="${acc.acc_address}"></p>
         <span class="room_detail_fee1">평균 이용가 : </span>&nbsp<span
            class="room_detail_fee2" th:text="${acc.acc_averPrice}"></span><span>
            원</span>
         <div class="coment_author">
            <p style="font-size: 12px; color: grey;">사장님 한마디</p>
            <p class="hotelcomment" th:text="${acc.acc_explain}"></p>
         </div>
      </div>
   </div>

   <div class="page_tab">
      <ul class="page_tabs">
         <li><a href="#view1" onclick="changeTabColor(0)">객실안내/예약</a></li>
         <li><a href="#view2" onclick="changeTabColor(1)">숙소정보</a></li>
         <li><a href="#view3" onclick="changeTabColor(2)">리뷰</a></li>
      </ul>
      <div class="tabcontents">
			<!--  객실 부분 -->
			<div id="view1">
				<section id="datepicker-container">
					<input type="text" id="datepicker1" name="checkIn" required>
					<button id="date-choose" onclick="totalPrice()">선택완료</button>
				</section>
				<div class="room" th:each="product : ${acc.products}">
					<div class="pic_view">
						<div th:each="img : ${product.productImgs}" class="imgContainer">
					 <img th:src="${img.img_url}" alt="Product Image" width="100%"
											height="100%" class=""></div>
					</div>
					<div class="room_info">
						<strong class="title" th:text="${product.product_type}"></strong>
						<div class="hotel">
							<div class="price"> 
								<strong> 가격 </strong>
								<!-- <p>다른날짜 확인</p> -->
								<p>
									<b id="totalAmount" style="color: rgba(0, 0, 0, 1)"
										th:text="${product.product_amount}"></b>
								</p>
							</div>
							<!-- <button type="button" onclick="pop_room_detail()">" 객실
								이용 안내"</button> -->
							<!-- <button type="button"> 판매완료 </button> -->
							<span id="hidden" hidden th:text="${product.product_id}" th:value="${product.product_id}"></span>
							<button class="btn_reserve" type="button" id="button" th:id="${product.product_id}" onclick="handleClick(this)">
							<span name="" th:value="${product.product_id}" id="reservePrice" th:text="${product.product_amount}"> <!-- onclick="handleClick(event)" --> 
							 </span>원 예약하기
							 </button>
						</div>
					</div>
				</div>
			</div>
         <!--  객실 끝  -->

         <div id="view2">
            <!-- 불러오기 성공 이제 수정들어가야 함 -->
            <pre
               style="font-family: 'AppleSDGothicNeo', 'Noto Sans KR', sans-serif; font-size: 14px;">
              <p th:utext="${@commonUtil.markdown(acc?.acc_info) ?: ''}"></p>
            </pre>

         <!--  map -->
            <div class="map" id="kakao_maps">
            
            <body>
<p style="margin-top:-12px">
</p>
<p style="font-weight:bold; font-size:18px;">찾아 오시는 길</p>
<div id="map" style="width:100%;height:300px;"></div>
 <script th:src="@{/js/kty_map.js}"></script>
</body>

<!--  지도 -->
            
            
            </div>

         </div>
         <div id="view3">
            <body>

               <div class="review_mb-3" name="myform" id="myform">
                  <br> <span id=review_title>별점과 이용경험을 남겨주세요.</span><br>
                  <form onsubmit="return validateForm()"
                     th:action="@{|/create/review/${acc.id}|}" method="post">
                     <fieldset id="room_start_k">
                        <input type="radio" name="reviewStar" value="5" id="rate1"><label
                           for="rate1">★</label> <input type="radio" name="reviewStar"
                           value="4" id="rate2"><label for="rate2">★</label> <input
                           type="radio" name="reviewStar" value="3" id="rate3"><label
                           for="rate3">★</label> <input type="radio" name="reviewStar"
                           value="2" id="rate4"><label for="rate4">★</label> <input
                           type="radio" name="reviewStar" value="1" id="rate5"><label
                           for="rate5">★</label>
                     </fieldset>
                     <div>
                        <textarea class="col-auto form-control" name="reviewContents"
                           id="reviewContents" placeholder="좋은 수강평을 남겨주시면 요기어때에 큰 힘이 됩니다!"></textarea>
                     </div>
                     <div id="error_message"></div>
                     <input sec:authorize="isAuthenticated()" type="submit"
                        value="리뷰작성" id="review_confirm">
                  </form>
                  <div class="sss">
                     <h2 id="title_revieww">리뷰 내역</h2>
                     <ul id="review_list">
                        <li class="ssss1" th:each="review : ${acc.reviews}"
                           style="border-bottom: 1px solid grey; width: 680px; padding-top: 10px;">
                           <p style="margin-bottom: 22px;">
                              <span
                                 th:text="${review.author.contains('name') ? 'Social_네이버회원' : (review.author.length() > 16 ? 'Social_구글회원' : 
                                 (review.author.length()>9 && review.author.length() < 13 ? 'Social_카카오회원' : review.author))}"
                                 style="font-weight: bold; font-size: 18px;"></span>


                              <button type="button" class="declaration"
                                 data-target="modal_declaration"
                                 th:data-review-id="${review.id}"
                                 sec:authorize="isAuthenticated()">신고</button>
                           </p>
                           <p class="start_score">
                              <span th:if="${review.rating == 1}" style="color: orange;">★
                                 ✩ ✩ ✩ ✩</span> <span th:if="${review.rating == 2}"
                                 style="color: orange;">★ ★ ✩ ✩ ✩</span> <span
                                 th:if="${review.rating == 3}" style="color: orange;">★
                                 ★ ★ ✩ ✩</span> <span th:if="${review.rating == 4}"
                                 style="color: orange;">★ ★ ★ ★ ✩</span> <span
                                 th:if="${review.rating == 5}" style="color: orange;">★
                                 ★ ★ ★ ★</span><span style="margin-left: 10px;"
                                 th:text="${review.rating}"> </span>
                           </p>
                           <p style="margin-bottom: 20px; color: rgb(80, 80, 80);">
                              <span th:text="${review.content}"></span>
                           </p>
                           <p>
                              <span class="time_real"
                                 th:text="${#temporals.format(review.create_reivew_Time, 'yyyy. MM. dd.  HH:mm')}"
                                 style="color: grey;"></span>
                           </p> <br>
                        </li>
                     </ul>

                  </div>


                  <!--  모달 (신고) -->

                  <div id="myModa" class="modal_declaration">
                     <div class="modal-content_declaration">
                        <span class="close">&times;</span>
                        <h3 style="text-align: center;">회원 신고</h3>
                        <div style="font-weight: bold;">신고 사유</div>
                        <br>
                        <form id="declarationForm" data-review-id="${review.id}">
                           <select id="reason_dec" name="reason">
                              <option value="">선택하세요</option>
                              <option value="욕설">욕설</option>
                              <option value="도배">도배</option>
                              <option value="광고">광고</option>
                              <option value="욕설 및 비방">욕설 및 비방</option>
                              <option value="허위·과장">허위·과장</option>
                              <option value="기타">기타</option>
                           </select><br> <br>
                           <div style="font-weight: bold;">상세 내용</div>
                           <br>
                           <textarea id="decl_detail" style="height: 280px; width: 380px;"
                              placeholder="상세 사유를 작성하세요"></textarea>
                           <br> <input type="submit" value="제출" id="declr_btn">
                        </form>
                     </div>
                  </div>


                  <!-- datepicker 적용 -->
						<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
						<script
							src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
						<!-- <scirpt src="../static/js/kdg_datepicker.js"></scirpt> -->
						<script th:inline="javascript">
						$(document).ready(function() {
							  $("#datepicker1").datepicker({
							    multidate: true,
							    format: 'yyyy-mm-dd',
							    startDate: '-0d',
							    endDate: '+2m +15d',
							    container: '#datepicker-container',
							    showOn: "button",
							    /* buttonImage: "URL_OF_YOUR_ICON_IMAGE",
							    buttonImageOnly: true */
							  });
							});
							
						
							/* 여러날짜를 입력받고 여러 날짜들중 가장 빠른날짜(체크인)와 가장 늦은 날짜를(체크아웃) 추출하는 함수*/
							function totalPrice() {
							  // #datepicker1 요소에서 선택한 날짜 범위를 가져옴
							  var selectedDates = $("#datepicker1").val();
							  // 선택한 날짜가 비어있는지(trim()으로 공백 제거 후 확인) 확인. 비어있다면 함수를 종료.
							  if (selectedDates.trim() === "") {
							    $("#datepicker1").val("");
							    return;
							  }
							  // 선택한 날짜를 쉼표로 분리하고(trim()으로 각 요소의 공백 제거) 배열로 만듬
							  var datesArray = selectedDates.split(",").map(date => date.trim());
							  // 유효한 날짜만 필터링하여 validDates 배열에 저장합니다. 유효한 날짜는 isDateValid 함수를 사용하여 확인
							  var validDates = datesArray.filter(date => isDateValid(date));
							  
							  // 배열이 비어있지 않은 경우, 배열 내의 날짜 중 가장 작은 값을 minDate에 저장하고, 가장 큰 값을 maxDate에 저장
							  if (validDates.length > 0) {
							    var minDate = new Date(Math.min(...validDates.map(date => new Date(date))));
							    var maxDate = new Date(Math.max(...validDates.map(date => new Date(date))));
								
							    // 각 날짜들을 fomatting해줄 함수에 대입하고 결과 값 변수에 저장.
							    var formattedMinDate = formatDate(minDate);
							    console.log(formattedMinDate);
							    var formattedMaxDate = formatDate(maxDate);
							    console.log(formattedMaxDate);
							    
							    // fomatting된 날짜들 세션에 저장하기 위해 각 변수에 저장.
							    const checkIn = formattedMinDate;
								console.log("@@@@@@@@@@@@@@@checkIn:",checkIn);
							    const checkOut = formattedMaxDate;
							    
							    // 체크인, 체크아웃 날짜 세션에 담기
							    sessionStorage.setItem("checkIn", checkIn);
							    sessionStorage.setItem("checkOut", checkOut);
							    
								// 화면에 보여질 두 날짜 형식 ex) 2023-07-17 ~ 2023-07-18
							    $("#datepicker1").val(formattedMinDate + " ~ " + formattedMaxDate);
								// minDate과 maxDate의 일수 차이 계산
							    const num = getDateDiff(minDate, maxDate);
							    console.log(num);
							    
							    // 각 객실의 금액과 숙박 일수를 곱함
							    setReservationSpanValue(num);
							    
							  } else {
							    $("#datepicker1").val(""); // 입력값이 공백이라면 datepicker 초기화
							  }
							}
							/* totalPrice() 끝*/
							
							/* totalPrice()에서 호출하는 함수들 */
							
							// 주어진 날짜가 'YYYY-MM-DD' 형식에 맞는지를 정규식을 사용하여 검사
							// isDateValid 함수는 주어진 날짜 문자열이 'YYYY-MM-DD' 형식에 맞으면 true를 반환하고, 그렇지 않으면 false를 반환
							function isDateValid(date) {
							  var regex = /^\d{4}-\d{2}-\d{2}$/;
							  return regex.test(date);
							}
							
							// 추출한 날짜 fomatting
							function formatDate(date) {
							  var year = date.getFullYear();
							  var month = (date.getMonth() + 1).toString().padStart(2, "0");
							  var day = date.getDate().toString().padStart(2, "0");
							  return year + "-" + month + "-" + day;
							}
							
							// 체크인과 체크아웃 사이의 일수 차이 계산
							function getDateDiff(date1, date2) {
							  const oneDay = 24 * 60 * 60 * 1000; // 하루를 밀리초로 나타냄
							  const diffDays = Math.round(Math.abs((date1 - date2) / oneDay));
							  return diffDays;
							}
							
							
							
							// 다수의 날짜를 입력받았을 경우, 가장 빠른 날과 늦은 날 사이의 일수 차이를 구한뒤 금액에 곱하는 함수
							// 동일한 일수 x 각 객실의 금액(1박 기준)
							function setReservationSpanValue(num) {
							  const reservePriceElements = document.querySelectorAll("#reservePrice");
							  const totalAmountElements = document.querySelectorAll("#totalAmount");
							
							  let index = 0;
							  for (const totalAmountElement of totalAmountElements) {
							    const totalAmount = parseInt(totalAmountElement.textContent);
							    const reservePriceElement = reservePriceElements[index];
							    const newValue = totalAmount * num;
							    const totalPrice = addCommas(newValue);
							    console.log('totalPrice',totalPrice);
							    reservePriceElement.textContent = totalPrice.toString();
							
							    index++;
							    if (index >= reservePriceElements.length) {
							      break;
							    }
							  }
							}
							
							// 정규 표현식을 사용하여 세 자리 마다 콤마를 추가하는 함수
							function addCommas(num) {
							  return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
							}
									
							/* 컨트롤러로 객실정보 보내는 함수 */
							function handleClick(button) {
						    const reservePriceElement = button.querySelector("#reservePrice");
						    const totalPrice1 = reservePriceElement.textContent;
						    const totalPrice = addCommas(totalPrice1);
						
						    console.log("totalPrice: ", totalPrice);
						
						    // 세션에 저장한 checkIn, checkOut 꺼냄
						    const checkIn = sessionStorage.getItem("checkIn");
						    console.log(checkIn);
						    const checkOut = sessionStorage.getItem("checkOut");
						    console.log(checkOut);
						
						    // value값 꺼내기
						    const roomID = reservePriceElement.getAttribute("value");
							
						    console.log(roomID);
						    console.log(typeof roomID);
						
						    const url = `/book/toss/${roomID}?totalPrice=${totalPrice}&checkIn=${checkIn}&checkOut=${checkOut}`;
						
						    fetch(url, {
						    	  method: 'GET',
						    	  headers: {
						    	    "Content-Type": "application/json",
						    	  }
						    	})
						    	  .then(response => {
						    	    if (!response.ok) {
						    	      throw new Error("Network response was not ok");
						    	    }
						    	    return response.json();
						    	  })
						    	  .then(data => {
						    		  const queryParams = new URLSearchParams();
						    		    if (data) {
						    		        // data가 null이 아닌 경우, 원하는 필드를 queryParams에 추가
						    		        if (data.bookerID) {
						    		            queryParams.append('bookerID', data.bookerID);
						    		        }
						    		        if (data.accomTitle) {
						    		            queryParams.append('accomTitle', data.accomTitle);
						    		        }
						    		        if (data.roomTitle) {
						    		            queryParams.append('roomTitle', data.roomTitle);
						    		        }
						    		        if (data.checkIn) {
						    		            queryParams.append('checkIn', data.checkIn);
						    		        }
						    		        if (data.checkOut) {
						    		            queryParams.append('checkOut', data.checkOut);
						    		        }
						    		        if (data.bookHeadCount) {
						    		            queryParams.append('bookHeadCount', data.bookHeadCount);
						    		        }
						    		        if (data.totalPrice) {
						    		            queryParams.append('totalPrice', data.totalPrice);
						    		        }
						    		        if (data.roomID) {
						    		            queryParams.append('roomID', data.roomID);
						    		        }
						    		        if (data.accomID) {
						    		            queryParams.append('accomID', data.accomID);
						    		        }
						    		        // 원하는 필드를 추가로 추가
						    		    }
						    	    
						    	    const newURL = "/kdg/reserve?" + queryParams.toString();
						    	    window.location.href = newURL; // 뷰 페이지 URL
						    	  })
						    	  .catch(error => {
						    	    console.error("Error occurred:", error);
						    	    // 오류 처리를 위한 추가적인 코드를 작성
						    	  });
						}	

						</script>
            </body>


            </body>

            <!--  리뷰 끝 -->


         </div>
      </div>
   </div>
</div>


</body>
<script>
   var accAverPrice = $('.room_detail_fee2').text();

   var formattedAccAverPrice = Number(accAverPrice).toLocaleString();

   $('.room_detail_fee2').text(formattedAccAverPrice);
</script>
</html>